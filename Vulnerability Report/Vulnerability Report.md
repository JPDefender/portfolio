# Vulnerability Report - Microsoft Defender & Power BI

## Objective
To build a comprehensive vulnerability report using Microsoft Defender vulnerability data across multiple tenants, visualized through Power BI dashboards for actionable security insights and prioritized remediation.

## Overview
This project demonstrates the process of collecting, analyzing, and presenting vulnerability data from Microsoft Defender for Endpoint using Power BI. The report covers a multi-tenant environment, pulling device inventories, vulnerability assessments, and CVE data from three separate Defender tenants. Data is transformed via Power Query (M language), loaded into a relational model, and presented through interactive dashboards that support biweekly exposure reporting and risk-based decision making.

> **Note:** All company names, tenant identifiers, device hostnames, internal domain names, and project/product names have been redacted and replaced with generic labels (Tenant_A, Tenant_B, Tenant_C and device group placeholders) to protect confidential information. Screenshots have been omitted for the same reason.

## Tools & Technologies
- **Microsoft Defender for Endpoint:** Source of vulnerability and threat data across managed devices.
- **Microsoft Power BI:** Data visualization and dashboard platform for building the report.
- **Power Query (M Language):** Data ingestion, transformation, and modeling within Power BI.
- **Microsoft 365 Defender Portal:** Central console for reviewing security recommendations and exposure scores.

## Data Sources
- **Device Inventory Exports (CSV):** Per-tenant device lists exported from Defender, containing device name, OS platform, tags, and onboarding status.
- **Vulnerability Exports (JSON/NDJSON):** Per-device CVE mappings exported from Defender's TVM module, including severity, exploitability, and age data.
- **Weaknesses Exports (XLSX):** TVM vulnerability spreadsheets with known-threat flags, age in days, and exposed machine counts.

## Report Architecture

The Power BI report is built on a multi-tenant data model with the following structure:

### Data Ingestion Queries
Each tenant has dedicated Power Query scripts for:
- **Devices (Current & Previous):** Import CSV device inventories, strip unnecessary columns, tag with tenant name, and standardize schema.
- **Weaknesses:** Dynamically locate the latest TVM vulnerability export (XLSX), filter to rows with known threats, and add age-category buckets (1-30 days, 30-90 days, 90-180 days, 180-365 days, 1+ years).
- **Vulnerabilities (Current & Previous):** A reusable `fn_LoadVulnerabilities` function that loads NDJSON/JSON.GZ files by date tag across all three tenant folders, parses each line, expands dynamic fields, and deduplicates by DeviceName + CveId + Tenant.

### Consolidated Views
- **Devices_Tags_Current / Devices_Tags_Previous:** Combines all three tenant device tables into a single unified view for cross-tenant analysis.

## Dashboard Pages

The report contains 16 interactive dashboard pages organized by device tag/group. Each device group page follows the same layout pattern: a donut chart showing severity distribution (Critical / High / Medium / Low), a side-by-side table comparing current vs. previous period vulnerability counts per device, and a total vulnerability count card. Trend pages add a bar chart broken down by CVE age category.

### General Page Setup

To recreate any device group page in Power BI:

1. **Add a Donut Chart** — Set the legend field to `Severity` (from the vulnerabilities table) and the values field to `Count of CveId`. Apply conditional formatting so Critical = red, High = orange, Medium = yellow, Low = blue.
2. **Add a Table Visual** — Columns: `DeviceName`, `CriticalCount`, `HighCount`, `MediumCount`, `LowCount`, `TotalVulnerabilities`. Sort descending by `TotalVulnerabilities`.
3. **Add a Card Visual** — Display the total vulnerability count for the selected group using a DAX measure: `Total Vulns = COUNTROWS(Vulnerabilities_Current)`.
4. **Add a Page-Level Filter** — Filter the page on the `DeviceTag` field to the relevant group name. This isolates the page to that device segment without needing separate data tables per group.
5. **Add a Slicer** — Optional tenant slicer to allow stakeholders to drill into a single tenant on any page.

---

### Internet Facing
Monitors internet-exposed devices and highlights any with exploitable vulnerabilities. Because these devices have external attack surface exposure, this page is configured to surface Critical and High findings first and flags any CVE with a known exploit using a conditional formatting rule on the `HasKnownExploit` column.

**Configuration note:** Set the page filter to `DeviceTag = "Internet Facing"`. Add an additional visual — a bar chart of `ExploitableVulns` by device — to make high-risk outliers immediately visible.

---

### [Build & Release - Prod]
Tracks vulnerabilities on production build and release agent devices, comparing current vs. previous reporting periods. This is a high-priority group because a compromise of a build agent can introduce supply-chain risk.

**Configuration note:** Set the page filter to the relevant build/release device tag. The current vs. previous comparison is achieved by placing two tables side by side — one sourced from `Devices_Tags_Current` and one from `Devices_Tags_Previous` — with a common `DeviceName` column for easy comparison.

---

### [Application Group A]
Covers a primary application server group with severity breakdown by device.

**Configuration note:** Set the page filter to the relevant application server device tag. Replicate the standard layout (donut + table + card) described in the General Page Setup section above.

---

### [Application Group B - Legacy]
Displays vulnerability counts for legacy application servers. Legacy environments often carry higher CVE age, so this page is useful for tracking long-standing vulnerabilities that have not been patched.

**Configuration note:** Set the page filter to the relevant legacy server device tag.

---

### [Application Group B - Legacy Non-Prod]
Non-production legacy environment vulnerability tracking. Useful for validating whether non-prod environments are held to the same patching standards as production.

**Configuration note:** Set the page filter to the relevant non-prod legacy device tag. Consider adding a text box annotation noting the non-prod status so report consumers don't conflate this with production risk.

---

### Automation
Shows vulnerability posture for automation infrastructure devices (e.g., scheduled task hosts, RPA agents, scripting servers).

**Configuration note:** Set the page filter to the relevant automation device tag.

---

### DevOps
Tracks vulnerabilities on DevOps tooling servers (e.g., CI/CD orchestrators, container hosts, artifact repositories).

**Configuration note:** Set the page filter to the relevant DevOps device tag.

---

### [Client Group]
Vulnerability overview for a specific client or partner-managed device group within the environment. This page follows the same layout as other device group pages.

**Configuration note:** Set the page filter to the relevant client/partner device tag.

---

### Corp IT
Corporate IT device group vulnerability summary with current vs. previous comparison. This group typically includes end-user workstations, help desk systems, and internal tooling.

**Configuration note:** Set the page filter to the `Corp IT` device tag.

---

### Not Tagged
Catches devices that haven't been assigned to any device tag group — useful for identifying coverage gaps in the tagging strategy.

**Configuration note:** Filter on `DeviceTag = null` or `DeviceTag = ""`. A high device count here indicates a gap in Defender tagging that should be resolved for accurate group-level reporting.

---

### All Tenant A Vulns Report
Consolidated view of all Tenant A vulnerabilities. This page is not filtered by device group — it shows the full tenant picture with a donut chart for severity distribution and a device-level breakdown table.

**Configuration note:** Filter the page on `Tenant = "Tenant_A"` only (no device tag filter). Add a summary card for total CVE count across the tenant and a table ranked by `TotalVulnerabilities` descending.

---

### Tenant A Vulnerability Trends Over Time
CVE age analysis showing how long vulnerabilities have been open across Tenant A.

**Configuration note:** Filter on `Tenant = "Tenant_A"`. Add a clustered bar chart with `AgeCategory` on the X axis (1-30 days, 30-90 days, 90-180 days, 180-365 days, 1+ years) and `Count of CveId` on the Y axis, broken down by severity. Below the chart, add a table with columns: `CveId`, `Severity`, `ExposedMachineCount`, `AgeCategory`, `HasKnownExploit`. Sort by `AgeCategory` descending to surface the oldest vulnerabilities first.

---

### All Tenant B Vulns Report
Consolidated view of all Tenant B vulnerabilities with device-level breakdown.

**Configuration note:** Filter the page on `Tenant = "Tenant_B"` only. Replicate the same layout used for the Tenant A full summary page.

---

### Tenant B Vulnerability Trends Over Time
CVE trending and age analysis for Tenant B, tracking exposed machines by severity over time.

**Configuration note:** Filter on `Tenant = "Tenant_B"`. Replicate the age-category bar chart and CVE detail table from the Tenant A trends page.

---

### All Tenant C Vulns Report
Full vulnerability summary across the Tenant C environment with a tag-level donut chart breakdown.

**Configuration note:** Filter the page on `Tenant = "Tenant_C"` only. Replicate the same layout used for Tenant A and Tenant B full summary pages.

---

### Tenant C Vulnerability Trends Over Time
Age-based CVE analysis for Tenant C, identifying long-standing vulnerabilities requiring attention.

**Configuration note:** Filter on `Tenant = "Tenant_C"`. Replicate the age-category bar chart and CVE detail table from the other trend pages.

---

## Power Query Scripts

The data pipeline is powered by custom Power Query (M) scripts. Each query handles a specific data source and tenant:

### Device Inventory Queries
- [`Tenant_A_Devices_Current.txt`](Images/Tenant_A_Devices_Current.txt) — Imports current Tenant A device inventory from CSV
- [`Tenant_A_Devices_Previous.txt`](Images/Tenant_A_Devices_Previous.txt) — Imports previous period Tenant A device inventory
- [`Tenant_B_Devices_Current.txt`](Images/Tenant_B_Devices_Current.txt) — Imports current Tenant B device inventory
- [`Tenant_B_Devices_Previous.txt`](Images/Tenant_B_Devices_Previous.txt) — Imports previous period Tenant B device inventory
- [`Tenant_C_Devices_Current.txt`](Images/Tenant_C_Devices_Current.txt) — Imports current Tenant C device inventory
- [`Tenant_C_Devices_Previous.txt`](Images/Tenant_C_Devices_Previous.txt) — Imports previous period Tenant C device inventory

### Weaknesses / CVE Queries
- [`Tenant_A_Weaknesses.txt`](Images/Tenant_A_Weaknesses.txt) — Loads latest TVM vulnerability export for Tenant A, filters to known threats, adds age categories
- [`Tenant_B_Weaknesses.txt`](Images/Tenant_B_Weaknesses.txt) — Same pattern for Tenant B
- [`Tenant_C_Weaknesses.txt`](Images/Tenant_C_Weaknesses.txt) — Same pattern for Tenant C

### Consolidated & Function Queries
- [`Devices_Tags_Current.txt`](Images/Devices_Tags_Current.txt) — Combines all three tenant device tables (current period) into one unified view
- [`Devices_Tags_Previous.txt`](Images/Devices_Tags_Previous.txt) — Combines all three tenant device tables (previous period)
- [`fn_LoadVulnerabilities.txt`](Images/fn_LoadVulnerabilities.txt) — Reusable function that loads and parses NDJSON/JSON.GZ vulnerability exports across all tenants by date tag
- [`Vulnerabilities_Current.txt`](Images/Vulnerabilities_Current.txt) — Calls `fn_LoadVulnerabilities` for the current reporting date
- [`Vulnerabilities_Previous.txt`](Images/Vulnerabilities_Previous.txt) — Calls `fn_LoadVulnerabilities` for the previous reporting date

## Methodology

### 1. Data Export from Microsoft Defender
- Exported device inventories as CSV from each Defender tenant via the Microsoft 365 Defender Portal (Endpoints > Device inventory > Export).
- Exported TVM vulnerability data as NDJSON (gzipped) via the Defender API or portal export, and weaknesses reports as XLSX via the Threat & Vulnerability Management blade.
- Organized exports into per-tenant folders using a consistent date-tagged naming convention (e.g., `YYYY-MM-DD`) to support biweekly tracking and the current vs. previous period comparison.

### 2. Data Transformation in Power BI
- Built Power Query scripts to ingest CSV, XLSX, and NDJSON/JSON.GZ files dynamically, using `Folder.Files` to pick the latest export by date tag without hardcoding file paths.
- Stripped unnecessary columns from device exports (IPs, MACs, enrollment details) to keep the model lean and avoid retaining unnecessary personal or network data.
- Created a reusable `fn_LoadVulnerabilities` function to parse multi-format vulnerability exports across all tenants.
- Added computed columns: Tenant tags, Age Categories (1-30 days through 1+ years), and normalized boolean fields.
- Deduplicated vulnerability records by DeviceName + CveId + Tenant to prevent double-counting across refresh cycles.

### 3. Dashboard Design
- Built 16 interactive dashboard pages — one per device tag/group plus tenant-wide summaries and trend views.
- Each device group page features a donut chart (severity distribution), current vs. previous device tables, and vulnerability totals.
- Trend pages include bar charts by age category and severity, plus detailed CVE tables with exposed machine counts.
- Applied conditional formatting to highlight Critical and High severity findings.

### 4. Biweekly Reporting Workflow
- The report is designed for biweekly refresh cycles: update the date tag parameter in `Vulnerabilities_Current` and `Vulnerabilities_Previous`, place the new export files in the appropriate tenant folder, and refresh the dataset in Power BI.
- Current vs. previous comparison tables enable stakeholders to see remediation progress at a glance without running separate queries.

## Key Findings
- Consolidated visibility into vulnerability posture across three Defender tenants and all device groups from a single Power BI report.
- Identified high-severity CVEs with known exploits aging over 1+ years that required priority patching.
- Tag-based grouping revealed which infrastructure segments carried the most risk, enabling targeted remediation prioritization.
- Biweekly comparison showed remediation trends and helped track mean time to remediate across reporting periods.

## Conclusion
This project showcases the ability to leverage Microsoft Defender for Endpoint as a vulnerability data source and Power BI as a reporting platform to build a professional, multi-tenant vulnerability management report. The combination of automated data ingestion via Power Query, structured multi-tenant analysis, and interactive visualization supports proactive security operations and informed risk management decisions.

## References
- [Microsoft Defender for Endpoint Documentation](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/)
- [Power BI Documentation](https://learn.microsoft.com/en-us/power-bi/)
- [Microsoft Defender Vulnerability Management](https://learn.microsoft.com/en-us/microsoft-365/security/defender-vulnerability-management/)
- [Power Query M Language Reference](https://learn.microsoft.com/en-us/powerquery-m/)
- [CVSS - Common Vulnerability Scoring System](https://www.first.org/cvss/)
