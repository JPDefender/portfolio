# Vulnerability Report - Microsoft Defender & Power BI

## Objective
To build a comprehensive vulnerability report using Microsoft Defender vulnerability data across multiple tenants, visualized through Power BI dashboards for actionable security insights and prioritized remediation.

## Overview
This project demonstrates the process of collecting, analyzing, and presenting vulnerability data from Microsoft Defender for Endpoint using Power BI. The report covers a multi-tenant environment, pulling device inventories, vulnerability assessments, and CVE data from three separate Defender tenants. Data is transformed via Power Query (M language), loaded into a relational model, and presented through interactive dashboards that support biweekly exposure reporting and risk-based decision making.

> **Note:** All company names, tenant identifiers, device hostnames, internal domain names, and project/product names have been redacted and replaced with generic labels (Tenant_A, Tenant_B, Tenant_C and device group placeholders) to protect confidential information. Screenshots have been omitted for the same reason.

## Tools & Technologies
- **Microsoft Defender for Endpoint:** Source of vulnerability and threat data across managed devices.
- **Microsoft Power BI:** Data visualization and dashboard platform for building the report.
- **Power Query (M Language):** Data ingestion, transformation, and modeling within Power BI.
- **Microsoft 365 Defender Portal:** Central console for reviewing security recommendations and exposure scores.

## Data Sources
- **Device Inventory Exports (CSV):** Per-tenant device lists exported from Defender, containing device name, OS platform, tags, and onboarding status.
- **Vulnerability Exports (JSON/NDJSON):** Per-device CVE mappings exported from Defender's TVM module, including severity, exploitability, and age data.
- **Weaknesses Exports (XLSX):** TVM vulnerability spreadsheets with known-threat flags, age in days, and exposed machine counts.

## Report Architecture

The Power BI report is built on a multi-tenant data model with the following structure:

### Data Ingestion Queries
Each tenant has dedicated Power Query scripts for:
- **Devices (Current & Previous):** Import CSV device inventories, strip unnecessary columns, tag with tenant name, and standardize schema.
- **Weaknesses:** Dynamically locate the latest TVM vulnerability export (XLSX), filter to rows with known threats, and add age-category buckets (1-30 days, 30-90 days, 90-180 days, 180-365 days, 1+ years).
- **Vulnerabilities (Current & Previous):** A reusable `fn_LoadVulnerabilities` function that loads NDJSON/JSON.GZ files by date tag across all three tenant folders, parses each line, expands dynamic fields, and deduplicates by DeviceName + CveId + Tenant.

### Consolidated Views
- **Devices_Tags_Current / Devices_Tags_Previous:** Combines all three tenant device tables into a single unified view for cross-tenant analysis.

## Dashboard Pages

The report contains 16 interactive dashboard pages organized by device tag/group. Each device group page follows the same layout pattern: a donut chart showing severity distribution (Critical / High / Medium / Low), a side-by-side table comparing current vs. previous period vulnerability counts per device, and a total vulnerability count card. Trend pages add a bar chart broken down by CVE age category.

### General Page Setup

To recreate any device group page in Power BI:

1. **Add a Donut Chart** — Set the legend field to `Severity` (from the vulnerabilities table) and the values field to `Count of CveId`. Apply conditional formatting so Critical = red, High = orange, Medium = yellow, Low = blue.
2. **Add a Table Visual** — Columns: `DeviceName`, `CriticalCount`, `HighCount`, `MediumCount`, `LowCount`, `TotalVulnerabilities`. Sort descending by `TotalVulnerabilities`.
3. **Add a Card Visual** — Display the total vulnerability count for the selected group using a DAX measure: `Total Vulns = COUNTROWS(Vulnerabilities_Current)`.
4. **Add a Page-Level Filter** — Filter the page on the `DeviceTag` field to the relevant group name. This isolates the page to that device segment without needing separate data tables per group.
5. **Add a Slicer** — Optional tenant slicer to allow stakeholders to drill into a single tenant on any page.

---

### Internet Facing
Monitors internet-exposed devices and highlights any with exploitable vulnerabilities. Because these devices have external attack surface exposure, this page is configured to surface Critical and High findings first and flags any CVE with a known exploit using a conditional formatting rule on the `HasKnownExploit` column.

**Configuration note:** Set the page filter to `DeviceTag = "Internet Facing"`. Add an additional visual — a bar chart of `ExploitableVulns` by device — to make high-risk outliers immediately visible.

---

### [Build & Release - Prod]
Tracks vulnerabilities on production build and release agent devices, comparing current vs. previous reporting periods. This is a high-priority group because a compromise of a build agent can introduce supply-chain risk.

**Configuration note:** Set the page filter to the relevant build/release device tag. The current vs. previous comparison is achieved by placing two tables side by side — one sourced from `Devices_Tags_Current` and one from `Devices_Tags_Previous` — with a common `DeviceName` column for easy comparison.

---

### [Application Group A]
Covers a primary application server group with severity breakdown by device.

**Configuration note:** Set the page filter to the relevant application server device tag. Replicate the standard layout (donut + table + card) described in the General Page Setup section above.

---

### [Application Group B - Legacy]
Displays vulnerability counts for legacy application servers. Legacy environments often carry higher CVE age, so this page is useful for tracking long-standing vulnerabilities that have not been patched.

**Configuration note:** Set the page filter to the relevant legacy server device tag.

---

### [Application Group B - Legacy Non-Prod]
Non-production legacy environment vulnerability tracking. Useful for validating whether non-prod environments are held to the same patching standards as production.

**Configuration note:** Set the page filter to the relevant non-prod legacy device tag. Consider adding a text box annotation noting the non-prod status so report consumers don't conflate this with production risk.

---

### Automation
Shows vulnerability posture for automation infrastructure devices (e.g., scheduled task hosts, RPA agents, scripting servers).

**Configuration note:** Set the page filter to the relevant automation device tag.

---

### DevOps
Tracks vulnerabilities on DevOps tooling servers (e.g., CI/CD orchestrators, container hosts, artifact repositories).

**Configuration note:** Set the page filter to the relevant DevOps device tag.

---

### [Client Group]
Vulnerability overview for a specific client or partner-managed device group within the environment. This page follows the same layout as other device group pages.

**Configuration note:** Set the page filter to the relevant client/partner device tag.

---

### Corp IT
Corporate IT device group vulnerability summary with current vs. previous comparison. This group typically includes end-user workstations, help desk systems, and internal tooling.

**Configuration note:** Set the page filter to the `Corp IT` device tag.

---

### Not Tagged
Catches devices that haven't been assigned to any device tag group — useful for identifying coverage gaps in the tagging strategy.

**Configuration note:** Filter on `DeviceTag = null` or `DeviceTag = ""`. A high device count here indicates a gap in Defender tagging that should be resolved for accurate group-level reporting.

---

### All Tenant A Vulns Report
Consolidated view of all Tenant A vulnerabilities. This page is not filtered by device group — it shows the full tenant picture with a donut chart for severity distribution and a device-level breakdown table.

**Configuration note:** Filter the page on `Tenant = "Tenant_A"` only (no device tag filter). Add a summary card for total CVE count across the tenant and a table ranked by `TotalVulnerabilities` descending.

---

### Tenant A Vulnerability Trends Over Time
CVE age analysis showing how long vulnerabilities have been open across Tenant A.

**Configuration note:** Filter on `Tenant = "Tenant_A"`. Add a clustered bar chart with `AgeCategory` on the X axis (1-30 days, 30-90 days, 90-180 days, 180-365 days, 1+ years) and `Count of CveId` on the Y axis, broken down by severity. Below the chart, add a table with columns: `CveId`, `Severity`, `ExposedMachineCount`, `AgeCategory`, `HasKnownExploit`. Sort by `AgeCategory` descending to surface the oldest vulnerabilities first.

---

### All Tenant B Vulns Report
Consolidated view of all Tenant B vulnerabilities with device-level breakdown.

**Configuration note:** Filter the page on `Tenant = "Tenant_B"` only. Replicate the same layout used for the Tenant A full summary page.

---

### Tenant B Vulnerability Trends Over Time
CVE trending and age analysis for Tenant B, tracking exposed machines by severity over time.

**Configuration note:** Filter on `Tenant = "Tenant_B"`. Replicate the age-category bar chart and CVE detail table from the Tenant A trends page.

---

### All Tenant C Vulns Report
Full vulnerability summary across the Tenant C environment with a tag-level donut chart breakdown.

**Configuration note:** Filter the page on `Tenant = "Tenant_C"` only. Replicate the same layout used for Tenant A and Tenant B full summary pages.

---

### Tenant C Vulnerability Trends Over Time
Age-based CVE analysis for Tenant C, identifying long-standing vulnerabilities requiring attention.

**Configuration note:** Filter on `Tenant = "Tenant_C"`. Replicate the age-category bar chart and CVE detail table from the other trend pages.

---

## Power Query Scripts

The data pipeline is powered by custom Power Query (M) scripts. Each query handles a specific data source and tenant:

### Device Inventory Queries
- [`Tenant_A_Devices_Current.txt`](Images/Tenant_A_Devices_Current.txt) — Imports current Tenant A device inventory from CSV
- [`Tenant_A_Devices_Previous.txt`](Images/Tenant_A_Devices_Previous.txt) — Imports previous period Tenant A device inventory
- [`Tenant_B_Devices_Current.txt`](Images/Tenant_B_Devices_Current.txt) — Imports current Tenant B device inventory
- [`Tenant_B_Devices_Previous.txt`](Images/Tenant_B_Devices_Previous.txt) — Imports previous period Tenant B device inventory
- [`Tenant_C_Devices_Current.txt`](Images/Tenant_C_Devices_Current.txt) — Imports current Tenant C device inventory
- [`Tenant_C_Devices_Previous.txt`](Images/Tenant_C_Devices_Previous.txt) — Imports previous period Tenant C device inventory

### Weaknesses / CVE Queries
- [`Tenant_A_Weaknesses.txt`](Images/Tenant_A_Weaknesses.txt) — Loads latest TVM vulnerability export for Tenant A, filters to known threats, adds age categories
- [`Tenant_B_Weaknesses.txt`](Images/Tenant_B_Weaknesses.txt) — Same pattern for Tenant B
- [`Tenant_C_Weaknesses.txt`](Images/Tenant_C_Weaknesses.txt) — Same pattern for Tenant C

### Consolidated & Function Queries
- [`Devices_Tags_Current.txt`](Images/Devices_Tags_Current.txt) — Combines all three tenant device tables (current period) into one unified view
- [`Devices_Tags_Previous.txt`](Images/Devices_Tags_Previous.txt) — Combines all three tenant device tables (previous period)
- [`fn_LoadVulnerabilities.txt`](Images/fn_LoadVulnerabilities.txt) — Reusable function that loads and parses NDJSON/JSON.GZ vulnerability exports across all tenants by date tag
- [`Vulnerabilities_Current.txt`](Images/Vulnerabilities_Current.txt) — Calls `fn_LoadVulnerabilities` for the current reporting date
- [`Vulnerabilities_Previous.txt`](Images/Vulnerabilities_Previous.txt) — Calls `fn_LoadVulnerabilities` for the previous reporting date

## Methodology

### 1. Data Export from Microsoft Defender
- Exported device inventories as CSV from each Defender tenant via the Microsoft 365 Defender Portal (Endpoints > Device inventory > Export).
- Exported TVM vulnerability data as NDJSON (gzipped) via the Defender API or portal export, and weaknesses reports as XLSX via the Threat & Vulnerability Management blade.
- Organized exports into per-tenant folders using a consistent date-tagged naming convention (e.g., `YYYY-MM-DD`) to support biweekly tracking and the current vs. previous period comparison.

### 2. Data Transformation in Power BI
- Built Power Query scripts to ingest CSV, XLSX, and NDJSON/JSON.GZ files dynamically, using `Folder.Files` to pick the latest export by date tag without hardcoding file paths.
- Stripped unnecessary columns from device exports (IPs, MACs, enrollment details) to keep the model lean and avoid retaining unnecessary personal or network data.
- Created a reusable `fn_LoadVulnerabilities` function to parse multi-format vulnerability exports across all tenants.
- Added computed columns: Tenant tags, Age Categories (1-30 days through 1+ years), and normalized boolean fields.
- Deduplicated vulnerability records by DeviceName + CveId + Tenant to prevent double-counting across refresh cycles.

### 3. Dashboard Design
- Built 16 interactive dashboard pages — one per device tag/group plus tenant-wide summaries and trend views.
- Each device group page features a donut chart (severity distribution), current vs. previous device tables, and vulnerability totals.
- Trend pages include bar charts by age category and severity, plus detailed CVE tables with exposed machine counts.
- Applied conditional formatting to highlight Critical and High severity findings.

### 4. Biweekly Reporting Workflow
- The report is designed for biweekly refresh cycles: update the date tag parameter in `Vulnerabilities_Current` and `Vulnerabilities_Previous`, place the new export files in the appropriate tenant folder, and refresh the dataset in Power BI.
- Current vs. previous comparison tables enable stakeholders to see remediation progress at a glance without running separate queries.

## Key Findings
- Consolidated visibility into vulnerability posture across three Defender tenants and all device groups from a single Power BI report.
- Identified high-severity CVEs with known exploits aging over 1+ years that required priority patching.
- Tag-based grouping revealed which infrastructure segments carried the most risk, enabling targeted remediation prioritization.
- Biweekly comparison showed remediation trends and helped track mean time to remediate across reporting periods.

## Conclusion
This project showcases the ability to leverage Microsoft Defender for Endpoint as a vulnerability data source and Power BI as a reporting platform to build a professional, multi-tenant vulnerability management report. The combination of automated data ingestion via Power Query, structured multi-tenant analysis, and interactive visualization supports proactive security operations and informed risk management decisions.

## How to Recreate This Report at a New Organization

This section documents every step required to rebuild this vulnerability reporting system from scratch at a new employer. All tool names and steps are environment-agnostic — substitute your actual tenant names, device group tags, and folder paths as appropriate.

---

### Step 1 — Confirm Prerequisites

Before starting, verify the following are in place:

| Requirement | Detail |
|---|---|
| **Microsoft Defender for Endpoint P2** | Required for Threat & Vulnerability Management (TVM) data. Included in M365 E5 or available as a standalone add-on. |
| **Portal Role** | Security Reader (minimum) or Security Administrator on each tenant you need to pull data from. |
| **Power BI Desktop** | Free download from [powerbi.microsoft.com](https://powerbi.microsoft.com). Used to build and edit the .pbix file. |
| **Power BI Pro or Premium** | Required to publish and share the report with stakeholders. Check with your org's M365 admin. |
| **Network access to Defender portals** | You need browser access to `security.microsoft.com` for each tenant, or API credentials if automating exports. |

---

### Step 2 — Map Out Your Tenants and Device Groups

Before touching any tooling, document your environment:

1. List every Defender tenant you have access to. Assign each a short label (e.g., `Tenant_A`, `Tenant_B`, or use meaningful names like `Corp`, `Subsidiary`, `Client`).
2. In each tenant's Defender portal, go to **Endpoints > Device inventory** and review the **Tags** column. List every tag value that represents a meaningful device group (e.g., `Internet Facing`, `Corp IT`, `DevOps`, `Automation`).
3. Decide on a naming convention for your export files. The recommended format is `YYYY-MM-DD` as a date prefix — this is what the `fn_LoadVulnerabilities` function uses to identify current vs. previous periods.

This mapping becomes your blueprint for how many dashboard pages you will build (one per device group) and how many Power Query scripts you will need (three per tenant: devices, weaknesses, vulnerabilities).

---

### Step 3 — Set Up Your Local Folder Structure

Create a root folder for the project (e.g., `VulnReport/`) and the following subdirectory layout. Keep this folder path consistent — Power Query will reference it directly.

```
VulnReport/
├── Tenant_A/
│   ├── Devices/
│   │   ├── 2025-01-01_devices.csv
│   │   └── 2025-01-15_devices.csv
│   ├── Vulnerabilities/
│   │   ├── 2025-01-01_vulns.json.gz
│   │   └── 2025-01-15_vulns.json.gz
│   └── Weaknesses/
│       ├── 2025-01-01_weaknesses.xlsx
│       └── 2025-01-15_weaknesses.xlsx
├── Tenant_B/
│   └── (same structure)
└── Tenant_C/
    └── (same structure)
```

> **Tip:** The date prefix in each filename is how the Power Query function distinguishes the "current" export from the "previous" one. Be consistent with this format from day one.

---

### Step 4 — Export Data from Microsoft Defender

Repeat the following for each tenant on each reporting cycle (biweekly recommended).

#### 4a — Device Inventory (CSV)

1. Go to `security.microsoft.com` and sign in to the target tenant.
2. Navigate to **Endpoints > Device inventory**.
3. Click **Export** (top right). Choose **Export all devices** or filter first if needed.
4. The downloaded CSV contains: `DeviceName`, `OSPlatform`, `Tags`, `OnboardingStatus`, and other fields.
5. Rename the file to `YYYY-MM-DD_devices.csv` and place it in `Tenant_X/Devices/`.
6. Repeat for each tenant.

#### 4b — Vulnerability Export (NDJSON / JSON.GZ)

1. In the Defender portal, navigate to **Vulnerability management > Vulnerabilities**.
2. Click **Export** to download the TVM vulnerability export. Defender exports this as a `.json.gz` (gzipped NDJSON) file.
3. Rename the file to `YYYY-MM-DD_vulns.json.gz` and place it in `Tenant_X/Vulnerabilities/`.
4. Repeat for each tenant.

> **Alternative (API):** You can automate this step using the Defender API endpoint `GET /api/machines/SoftwareVulnerabilitiesByMachine`. This requires an App Registration in Azure AD with `Vulnerability.Read.All` permission. Useful for large environments where manual exports are impractical.

#### 4c — Weaknesses Export (XLSX)

1. In the Defender portal, navigate to **Vulnerability management > Weaknesses**.
2. Click **Export**. Defender downloads this as an `.xlsx` file.
3. Rename it to `YYYY-MM-DD_weaknesses.xlsx` and place it in `Tenant_X/Weaknesses/`.
4. Repeat for each tenant.

---

### Step 5 — Create the Power BI File and Connect to Data

1. Open **Power BI Desktop**.
2. Click **Get data > Blank query** to open the Power Query editor (this is where all the scripts go).
3. In the Power Query editor, go to **Home > New Source > Blank Query** for each script you need to create.
4. For each query, paste the script from the `Images/` folder of this project (the `.txt` files), replacing all hardcoded folder paths with your actual `VulnReport/` path.

> **Setting folder paths:** Every script that uses `Folder.Files(...)` needs to point to your local or shared drive path. Update this in each query. If the file is stored on a shared drive or SharePoint, use the appropriate connector (`SharePoint.Files` instead of `Folder.Files`).

---

### Step 6 — Build the Power Query Scripts

Create the following named queries in this order (dependencies matter):

#### 6a — Per-Tenant Device Queries (create one set per tenant)

For each tenant, create two queries — `Tenant_A_Devices_Current` and `Tenant_A_Devices_Previous`:

- Use `Folder.Files("path/to/Tenant_A/Devices/")` to list all CSVs in the folder.
- Sort by `Date modified` descending. Take the first row for Current, the second row for Previous.
- Load the CSV, remove unnecessary columns (keep: `DeviceName`, `OSPlatform`, `Tags`, `OnboardingStatus`).
- Add a custom column: `Tenant = "Tenant_A"`.

Reference the saved `.txt` script files in this project for the exact M code.

#### 6b — Per-Tenant Weaknesses Queries (create one per tenant)

For each tenant, create `Tenant_A_Weaknesses`:

- Use `Folder.Files("path/to/Tenant_A/Weaknesses/")` to find the latest XLSX by date.
- Load the Excel file, navigate to the relevant sheet.
- Filter rows where `HasKnownExploit = true` (or `1`) to focus on actionable CVEs.
- Add an `AgeCategory` column using a conditional column on `AgeInDays`:
  - `<= 30` → `"1-30 Days"`
  - `<= 90` → `"30-90 Days"`
  - `<= 180` → `"90-180 Days"`
  - `<= 365` → `"180-365 Days"`
  - `> 365` → `"1+ Years"`

#### 6c — The fn_LoadVulnerabilities Function (create once, reused by all tenants)

This is the most important query. Create it as a **function** in Power Query:

- The function accepts two parameters: `DateTag` (text, e.g., `"2025-01-15"`) and `TenantFolder` (text, the folder path).
- It uses `Folder.Files(TenantFolder)` to find the file matching the date tag.
- It reads the `.json.gz` file, decompresses it, splits it by newline, and parses each line as JSON.
- It expands all dynamic fields (CveId, Severity, ExploitabilityLevel, etc.).
- It adds the `Tenant` label column.
- It deduplicates by `DeviceName + CveId + Tenant`.

Reference `fn_LoadVulnerabilities.txt` for the full M code.

#### 6d — Vulnerabilities Current and Previous Queries

Create `Vulnerabilities_Current` and `Vulnerabilities_Previous`:

- Each simply calls `fn_LoadVulnerabilities` with the appropriate date tag and a list of all tenant folders.
- To update for a new reporting cycle, you only change the date string in these two queries and refresh — everything else updates automatically.

Example call structure:
```
fn_LoadVulnerabilities("2025-01-15", "C:/VulnReport/Tenant_A/Vulnerabilities/")
```
Then append (union) the results across all tenants into a single table.

#### 6e — Consolidated Device Tag Queries

Create `Devices_Tags_Current` and `Devices_Tags_Previous`:

- Each uses `Table.Combine({Tenant_A_Devices_Current, Tenant_B_Devices_Current, Tenant_C_Devices_Current})` to union all tenant device tables into one view.
- This combined table is what the dashboard pages filter against by `DeviceTag`.

---

### Step 7 — Build the Data Model

After all queries load successfully:

1. Go to **Model view** in Power BI Desktop.
2. Create a relationship between `Devices_Tags_Current[DeviceName]` and `Vulnerabilities_Current[DeviceName]` (many-to-one, single direction).
3. Create the same relationship between the `Previous` tables.
4. Verify no circular dependencies exist.

---

### Step 8 — Create Key DAX Measures

In the **Data pane**, create a dedicated **Measures** table and add the following:

```dax
Total Vulns Current = COUNTROWS(Vulnerabilities_Current)

Critical Count = CALCULATE(COUNTROWS(Vulnerabilities_Current), Vulnerabilities_Current[Severity] = "Critical")

High Count = CALCULATE(COUNTROWS(Vulnerabilities_Current), Vulnerabilities_Current[Severity] = "High")

Medium Count = CALCULATE(COUNTROWS(Vulnerabilities_Current), Vulnerabilities_Current[Severity] = "Medium")

Low Count = CALCULATE(COUNTROWS(Vulnerabilities_Current), Vulnerabilities_Current[Severity] = "Low")

Exploitable Vulns = CALCULATE(COUNTROWS(Vulnerabilities_Current), Vulnerabilities_Current[HasKnownExploit] = TRUE())
```

---

### Step 9 — Build the Dashboard Pages

#### Standard Device Group Page (repeat for each device tag)

1. Add a new report page and name it after the device group.
2. Add a **Page-level filter**: set `Devices_Tags_Current[Tags]` = the relevant tag value for this group.
3. **Donut chart** — Legend: `Severity`, Values: `Count of CveId`. Apply conditional color formatting (Critical = red, High = orange, Medium = yellow, Low = blue).
4. **Table — Current period** — Columns: `DeviceName`, `Critical Count`, `High Count`, `Medium Count`, `Low Count`, `Total Vulns Current`. Sort descending by total.
5. **Table — Previous period** — Same columns but sourced from `Vulnerabilities_Previous` and `Devices_Tags_Previous`.
6. **Card visual** — Display `Total Vulns Current` measure.
7. Optional: **Slicer** on `Tenant` to allow drilling into a single tenant.

#### Tenant Summary Pages (one per tenant)

Same as above but remove the device tag page filter and instead filter on `Tenant = "Tenant_X"`. Show all device groups for that tenant on one page.

#### Trend Pages (one per tenant)

1. Set a page-level filter on `Tenant = "Tenant_X"`.
2. **Clustered bar chart** — X-axis: `AgeCategory` (from Weaknesses table), Y-axis: `Count of CveId`, Legend: `Severity`. Sort the X-axis in order: 1-30 Days, 30-90 Days, 90-180 Days, 180-365 Days, 1+ Years.
3. **Detail table** — Columns: `CveId`, `Severity`, `ExposedMachineCount`, `AgeCategory`, `HasKnownExploit`. Sort by `AgeCategory` descending to surface the oldest CVEs first.

---

### Step 10 — Biweekly Refresh Workflow

Each reporting cycle (recommended every two weeks):

1. Export fresh data from each Defender tenant for all three data types (devices, vulnerabilities, weaknesses) following Step 4.
2. Name the new files with the current date tag (`YYYY-MM-DD`).
3. Drop the files into the appropriate `Tenant_X/` subfolder — do not delete the previous cycle's files (Power Query selects the two most recent automatically).
4. Open Power BI Desktop and open the `.pbix` file.
5. In the Power Query editor, update the `DateTag` parameter in `Vulnerabilities_Current` to today's date, and in `Vulnerabilities_Previous` to the previous cycle's date.
6. Click **Close & Apply**, then **Refresh**.
7. Verify all visuals updated — the previous period tables should now reflect what was "current" last cycle, and the current tables show the new data.
8. Publish to Power BI Service (if applicable) and notify stakeholders.

---

### Step 11 — Adapting This for a New Employer

When starting at a new organization:

1. **Identify tenants** — Ask the security team or your manager how many Defender tenants exist and request Security Reader access to each.
2. **Identify device groups** — Pull a device inventory export and review the `Tags` column. If devices are not tagged, work with the team to establish a tagging strategy before building the report — tags are the foundation of the page structure.
3. **Rename all placeholders** — Replace `Tenant_A/B/C` throughout the Power Query scripts with your actual tenant names. Replace generic device group names (e.g., `[Build & Release - Prod]`) with the actual tag values from your environment.
4. **Adjust dashboard pages** — Add or remove pages to match the number of device groups in the new environment. The template layout (donut + current/previous tables + card) stays the same for every group.
5. **Check export formats** — Defender export formats are standardized across tenants, so the Power Query scripts should work without modification to the parsing logic. The only changes needed are folder paths and tenant labels.
6. **Set up a shared drive or SharePoint folder** — If the report will be maintained by a team, store the `VulnReport/` folder on a shared drive and update the `Folder.Files` paths in Power Query accordingly. Use `SharePoint.Files` if using SharePoint Online.
7. **Schedule automated refresh** — If publishing to Power BI Service, configure a scheduled refresh using an on-premises data gateway (if data is stored locally) or directly (if data is in SharePoint/OneDrive).

---

## References
- [Microsoft Defender for Endpoint Documentation](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/)
- [Power BI Documentation](https://learn.microsoft.com/en-us/power-bi/)
- [Microsoft Defender Vulnerability Management](https://learn.microsoft.com/en-us/microsoft-365/security/defender-vulnerability-management/)
- [Power Query M Language Reference](https://learn.microsoft.com/en-us/powerquery-m/)
- [CVSS - Common Vulnerability Scoring System](https://www.first.org/cvss/)
